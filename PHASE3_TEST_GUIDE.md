# Phase 3: バックグラウンド録音 & トレイ統合 テストガイド

## 実装内容

Phase 3では、以下の機能を実装しました：

1. **システムトレイ統合**
   - トレイアイコン表示
   - トレイメニューからの録音制御
   - 録音状態に応じたアイコン変更（idle / recording / paused）
   - 通知機能

2. **バックグラウンド動作**
   - ウィンドウを閉じてもアプリは終了せずトレイに常駐
   - トレイメニューから明示的に終了可能

3. **グローバルショートカット** (既存機能)
   - `Ctrl+Shift+R`: 録音開始/停止
   - `Ctrl+Shift+P`: 一時停止/再開

4. **録音停止タイマー修正**
   - 停止ボタン押下後、即座に時間カウントが停止

## テスト前の準備

### 1. アプリケーションの起動確認

```bash
# 開発サーバーが起動していることを確認
npm run dev
```

アプリケーションウィンドウが表示されることを確認します。

### 2. 既知の警告について

以下の警告は正常です（無視してOK）：
- `[WARN] Icon file not found, using default app icon` - トレイアイコンファイルが未作成のため
- グローバルショートカットの登録失敗 - ショートカットキーが既に使用されている場合

## テスト手順

### テスト1: トレイアイコンの表示確認

**手順:**
1. アプリケーションを起動
2. Windows: タスクバーの通知領域（右下）を確認
3. macOS: メニューバーの右側を確認

**期待結果:**
- ✅ トレイアイコンが表示される
- ✅ アイコンにマウスホバーすると「Recording App」と表示される

### テスト2: トレイメニューの表示確認

**手順:**
1. トレイアイコンを右クリック（macOS: 左クリック）

**期待結果:**
- ✅ コンテキストメニューが表示される
- ✅ 以下のメニュー項目が表示される：
  - Recording App （無効化状態）
  - ウィンドウを表示
  - ⏺️ 録音を開始
  - ⚙️ 設定
  - 終了

### テスト3: ウィンドウの表示/非表示

**手順:**
1. トレイメニューから「ウィンドウを表示」をクリック
2. メインウィンドウが表示されることを確認
3. メインウィンドウの「×」ボタンをクリック

**期待結果:**
- ✅ ウィンドウが非表示になる（終了しない）
- ✅ 通知が表示される：「アプリはバックグラウンドで実行中です。トレイアイコンから操作できます。」
- ✅ アプリケーションは終了せず、トレイに常駐している
- ✅ トレイアイコンをクリックするとウィンドウが再表示される

### テスト4: トレイからの録音開始

**手順:**
1. トレイメニューから「⏺️ 録音を開始」をクリック
2. ウィンドウを表示して録音状態を確認

**期待結果:**
- ✅ 録音が開始される
- ✅ ウィンドウの時間カウンターが動作している
- ✅ 通知が表示される：「録音開始 - 録音を開始しました」
- ✅ トレイアイコンが変化する（録音中状態）
- ✅ トレイメニューが以下に変化する：
  - ⏸️ 録音を一時停止
  - ⏹️ 録音を停止

### テスト5: トレイからの録音一時停止

**前提:** テスト4で録音が開始されている

**手順:**
1. トレイメニューから「⏸️ 録音を一時停止」をクリック

**期待結果:**
- ✅ 録音が一時停止される
- ✅ ウィンドウの時間カウンターが停止する
- ✅ 通知が表示される：「録音一時停止 - 録音を一時停止しました」
- ✅ トレイアイコンが変化する（一時停止状態）
- ✅ トレイメニューが「▶️ 録音を再開」に変化する

### テスト6: トレイからの録音再開

**前提:** テスト5で録音が一時停止されている

**手順:**
1. トレイメニューから「▶️ 録音を再開」をクリック

**期待結果:**
- ✅ 録音が再開される
- ✅ ウィンドウの時間カウンターが再度動作する
- ✅ 通知が表示される：「録音再開 - 録音を再開しました」
- ✅ トレイアイコンが録音中状態に戻る

### テスト7: トレイからの録音停止

**前提:** 録音が進行中

**手順:**
1. トレイメニューから「⏹️ 録音を停止」をクリック

**期待結果:**
- ✅ 録音が停止される
- ✅ ファイル保存処理が実行される
- ✅ 通知が表示される：「録音停止 - 録音を停止しました（X秒）」
- ✅ トレイアイコンがアイドル状態に戻る
- ✅ トレイメニューが「⏺️ 録音を開始」に戻る

### テスト8: 録音中の終了防止

**前提:** 録音が進行中

**手順:**
1. トレイメニューから「終了」をクリック

**期待結果:**
- ✅ アプリケーションは終了しない
- ✅ 通知が表示される：「録音中です - 録音を停止してから終了してください」
- ✅ メインウィンドウが表示される

### テスト9: 通常終了

**前提:** 録音が停止している

**手順:**
1. トレイメニューから「終了」をクリック

**期待結果:**
- ✅ アプリケーションが正常に終了する
- ✅ トレイアイコンが消える
- ✅ すべてのプロセスが終了する

### テスト10: グローバルショートカット（オプション）

**注意:** ショートカットキーが既に使用されている場合、このテストはスキップしてください。

**手順:**
1. アプリケーションがバックグラウンドで実行中
2. `Ctrl+Shift+R`を押す

**期待結果:**
- ✅ 録音が開始される（停止中の場合）
- ✅ 録音が停止される（録音中の場合）

**手順:**
3. 録音中に`Ctrl+Shift+P`を押す

**期待結果:**
- ✅ 録音が一時停止される（録音中の場合）
- ✅ 録音が再開される（一時停止中の場合）

### テスト11: 録音停止タイマー修正（Phase 2バグ修正）

**手順:**
1. 録音を開始
2. 10秒ほど待機
3. 「録音停止」ボタンをクリック
4. 時間カウンターの動作を観察

**期待結果:**
- ✅ 停止ボタンをクリックした瞬間に時間カウンターが停止する
- ❌ ファイル保存中も時間がカウントされ続ける（バグ） - **このバグは修正済み**

## 実装されたファイル

### 新規作成
- `src/main/services/TrayService.ts` - トレイサービス実装
- `src/assets/icons/README.md` - トレイアイコン仕様書

### 変更
- `src/main/index.ts` - トレイサービス統合、ウィンドウクローズ処理変更
- `src/main/ipc/recordingHandlers.ts` - トレイ状態更新の追加
- `src/renderer/components/RecordingPanel.tsx` - トレイイベントハンドラー追加、タイマーバグ修正
- `src/renderer/stores/historyStore.ts` - updateMemoメソッドの型定義追加
- `src/shared/types/index.ts` - saveRecordingFilesをオプショナルから必須に変更
- `src/renderer/services/RecordingService.ts` - Uint8Array型の明示化

## 既知の問題

### 1. グローバルショートカット登録失敗

**現象:**
```
[ERROR] [GlobalShortcut] Failed to register Start/Stop shortcut
[ERROR] [GlobalShortcut] Failed to register Pause/Resume shortcut
```

**原因:**
- ショートカットキーが既に他のアプリケーションで使用されている
- または、Electron権限の問題

**対処:**
- この問題は機能には影響しません（トレイメニューから操作可能）
- 将来的に設定画面でショートカットキーをカスタマイズ可能にする予定

### 2. トレイアイコンがデフォルト

**現象:**
```
[WARN] Icon file not found, using default app icon
```

**原因:**
- `src/assets/icons/`に専用のトレイアイコンファイルが未配置

**対処:**
- アイコンファイルを配置することで解決
- 詳細は`src/assets/icons/README.md`を参照
- 現在はアプリのデフォルトアイコンが使用される（機能には影響なし）

## テスト結果の報告

テストが完了したら、以下のチェックリストを確認してください：

- [ ] すべてのテストケースが成功した
- [ ] トレイアイコンが正常に表示される
- [ ] トレイメニューから録音制御ができる
- [ ] ウィンドウを閉じてもアプリが終了しない
- [ ] 通知が正常に表示される
- [ ] 録音中は終了できない
- [ ] 録音停止後、時間カウンターが即座に停止する

すべてのテストが成功した場合、Phase 3は完了です！

## 次のステップ

Phase 3完了後、以下のいずれかに進みます：

1. **トレイアイコンの作成** - より見やすいアイコンを作成
2. **Phase 4: クラウド連携** - Google Drive/Dropbox統合
3. **設定画面の改善** - ホットキーのカスタマイズ機能追加
